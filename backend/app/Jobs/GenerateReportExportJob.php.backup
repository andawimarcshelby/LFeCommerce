<?php

namespace App\Jobs;

use App\Models\ReportJob;
use App\Services\ReportQueryBuilder;
use App\Services\PdfReportGenerator;
use App\Services\ExcelReportGenerator;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Facades\Log;
    public function __construct(ReportJob $reportJob)
    {
        $this->reportJob = $reportJob;
        $this->onQueue('exports');
    }

    /**
     * Execute the job.
     */
    public function handle(
        ReportQueryBuilder $queryBuilder,
        PdfReportGenerator $pdfGenerator,
        ExcelReportGenerator $excelGenerator
    ): void {
        try {
            // Mark as running
            $this->reportJob->update([
                'status' => 'running',
                'started_at' => now(),
            ]);

            Log::info("Starting report export", [
                'job_id' => $this->reportJob->id,
                'report_type' => $this->reportJob->report_type,
                'format' => $this->reportJob->format,
            ]);

            // Build query based on report type
            $query = $this->buildQuery($queryBuilder);

            // Count total rows
            $totalRows = $query->count();
            $this->reportJob->update(['total_rows' => $totalRows]);

            // Fetch data
            $data = $query->limit(100000)->get()->toArray(); // Limit for safety

            // Progress callback
            $progressCallback = function ($processed, $total, $section) {
                $this->reportJob->updateProgress($processed, $total, $section);
            };

            // Generate report based on format
            $filePath = $this->generateReport(
                $data,
                $query,
                $pdfGenerator,
                $excelGenerator,
                $progressCallback
            );

            // Get file size
            $fileSize = file_exists($filePath) ? filesize($filePath) : 0;

            // Mark as completed
            $this->reportJob->markCompleted($filePath, $fileSize);

            Log::info("Report export completed", [
                'job_id' => $this->reportJob->id,
                'file_path' => $filePath,
                'file_size' => $fileSize,
            ]);

            // Send completion notification
            $this->reportJob->user->notify(new \App\Notifications\ReportExportCompleted($this->reportJob));

        } catch (Exception $e) {
            Log::error("Report export failed", [
                'job_id' => $this->reportJob->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            $this->reportJob->markFailed($e->getMessage());

            throw $e; // Re-throw to trigger retry
        }
    }

    /**
     * Build query based on report type
     */
    private function buildQuery(ReportQueryBuilder $queryBuilder)
    {
        $filters = $this->reportJob->filters;

        return match ($this->reportJob->report_type) {
            'detail' => $queryBuilder->buildCourseEventsQuery($filters),
            'summary' => $queryBuilder->buildSummaryQuery($filters),
            'top_n' => $queryBuilder->buildTopNQuery($filters, 'students'),
            'per_student' => $queryBuilder->buildPerStudentQuery($filters),
            default => throw new Exception('Unknown report type: ' . $this->reportJob->report_type),
        };
    }

    /**
     * Generate report file
     */
    private function generateReport(
        array $data,
        $query,
        PdfReportGenerator $pdfGenerator,
        ExcelReportGenerator $excelGenerator,
        callable $progressCallback
    ): string {
        $metadata = [
            'title' => $this->getReportTitle(),
            'columns' => $this->getColumnHeaders(),
        ];

        if ($this->reportJob->format === 'pdf') {
            return $pdfGenerator->generate(
                $this->reportJob->report_type,
                $data,
                $metadata,
                $progressCallback
            );
        }

        if ($this->reportJob->format === 'xlsx') {
            return $excelGenerator->generate(
                $query,
                $metadata,
                $progressCallback
            );
        }

        throw new Exception('Unknown format: ' . $this->reportJob->format);
    }

    /**
     * Get report title
     */
    private function getReportTitle(): string
    {
        return match ($this->reportJob->report_type) {
            'detail' => 'Course Events Detail Report',
            'summary' => 'Course Activity Summary Report',
            'top_n' => 'Top Students by Engagement',
            'per_student' => 'Per-Student Activity Report',
            default => 'LMS Activity Report',
        };
    }

    /**
     * Get column headers
     */
    private function getColumnHeaders(): array
    {
        return match ($this->reportJob->report_type) {
            'detail' => ['Event Type', 'Student', 'Course', 'Term', 'Date'],
            'summary' => ['Date', 'Course', 'Events', 'Students', 'Page Views', 'Video Minutes'],
            'top_n' => ['Rank', 'Student', 'Program', 'Total Events', 'Participation Score'],
            'per_student' => ['Student Number', 'Name', 'Program', 'Year'],
            default => ['Data'],
        };
    }

    /**
     * Handle job failure
     */
    public function failed(Exception $exception): void
    {
        Log::error("Report job permanently failed", [
            'job_id' => $this->reportJob->id,
            'error' => $exception->getMessage(),
        ]);

        $this->reportJob->markFailed(
            "Job failed after {$this->tries} attempts: " . $exception->getMessage()
        );

        // Send failure notification
        $this->reportJob->user->notify(new \App\Notifications\ReportExportFailed($this->reportJob));
    }
}
